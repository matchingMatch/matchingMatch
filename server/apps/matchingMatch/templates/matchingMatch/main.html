<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <title>매칭매치</title>
</head>
<body>
  {% include 'matchingMatch/navbar.html' %}
  <header>
    <h1>Matching Match</h1>
    <h1>매칭매치</h1>
    <div class="alarm_modal_list">
    </div>
  </header>
  <main>
    <div class="week_slideshow">
      <ul class="week">
        <li class='date'><div>x요일</div><div>x일</div></li>
      </ul>
      <p class="controller">
      
      <!-- &lang: 왼쪽 방향 화살표
      &rang: 오른쪽 방향 화살표 -->
        <span class="prev">&lang;</span>
        <span class="next">&rang;</span>
      </p>
    </div>

                  <button name="gender" data-toggle="false" data value data-type="female">여성</button>
    <div class="match_filter container">
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#matchFilter" aria-expanded="true" aria-controls="matchFilter">
        상세설정
      </button>
      <div id="matchFilter" class="collapse">
        <div class="gender">
          <b>성별</b>
          <button name="gender" data-toggle="true" data value data-type="all">전체</button>
          <button name="gender" data-toggle="false" data value data-type="male">남성</button>
          <button name="gender" data-toggle="false" data value data-type="female">여성</button>
          <button name="gender" data-toggle="false" data value data-type="mixed">혼성</button>
        </div>
        <div class="region">
          <b>지역</b>
          <button name="gender" data-toggle="true" data value data-type="all">전체</button>
          <button name="gender" data-toggle="false" data value data-type="westnorth">서북권</button>
          <button name="gender" data-toggle="false" data value data-type="middlenorth">도심권</button>
          <button name="gender" data-toggle="false" data value data-type="eastnorth">동북권</button>
          <button name="gender" data-toggle="false" data value data-type="westsouth">서남권</button>
          <button name="gender" data-toggle="false" data value data-type="eastsouth">동남권</button>
        </div>
        <div class="is_matched">
          <b>마감 여부</b>
          <button name="gender" data-toggle="true" data value data-type="all">전체</button>
          <button name="gender" data-toggle="false" data value data-type="is_not_matched">마감 안됨</button>
        </div>
        <div class="time">
          <b>시간</b>
          <button name="time" data-toggle="true" data value data-type="all">전체</button>
          <button name="time" data-toggle="false" data value data-type="beforenoon">오전</button>
          <button name="time" data-toggle="false" data value data-type="afternoon">오후 12시~6시</button>
          <button name="time" data-toggle="false" data value data-type="night">오후 6시 이후</button>
        </div>
      </div>
    </div>
    
    <ul class="match_list">
      {% for match in matches %}
      <a href="{% url 'matchingMatch:match_detail' match.pk%}">
        <div>{{match.start_time}} ~ {{match.end_time}}</div>
        <div>
          축구장 : {{match.stadium.stadium_name}} 
          <br>성별 : {{match.get_gender_display}}
        </div>
        <div>
          {% if match.is_matched %}
          <div> {{match.host_id.team_name}} vs {{match.participant_id.team_name}}</div>
          <div>매치성사</div>
          <br>
          {% else %}
          <div>{{match.host_id.team_name}}</div>
          <div>찾는 중</div>
          <br>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </ul>
    <div class="match_register_btn">
      <a href="{% url 'matchingMatch:match_register'%}">매치 등록하기</a>
    </div>
  </main>
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  let date = new Date()
  const thisYear = date.getFullYear()
  const thisMonth = date.getMonth()
  const thisDate = date.getDate()
  const thisDay = date.getDay()
  const lastDate = new Date(thisYear, thisMonth + 1, 0).getDate()
  daysKorean = ['일', '월', '화', '수', '목', '금', '토']
  days=[]
  dates = []
  
  for (let i = thisDate; i <= lastDate; i++) {
    dates.push(i)
  }
  thisDateLength = dates.length
  for (let i = 1; i <= 31-thisDateLength; i++) {
    dates.push(i)
  }
  
  let dayIndex = thisDay
  dates.forEach((date, i) => {
    let condition = dayIndex%7 == 0 ? 'sun' : dayIndex%7 == 6 ? 'sat' : 'rest_day'
    dates[i] = `<li class='date ${condition}'><div>${daysKorean[(dayIndex++%7)]}요일</div><div>${date}일</div></li> ` 
  })

  const week = document.querySelector('.week')
  week.innerHTML = dates.join('')
  


  //https://eunhee-programming.tistory.com/106
  const slides = document.querySelector('.week'); //전체 슬라이드 컨테이너
  const slideDate = document.querySelectorAll('.date'); //모든 슬라이드들
  let currentIdx = 0; //현재 슬라이드 index
  const slideDateCount = slideDate.length; // 슬라이드 개수
  const prev = document.querySelector('.prev'); //이전 버튼
  const next = document.querySelector('.next'); //다음 버튼
  const slideWidth = 50; //한개의 슬라이드 넓이
  const slideMargin = 50; //슬라이드간의 margin 값

  //전체 슬라이드 컨테이너 넓이 설정
  slides.style.width = (slideWidth + slideMargin) * slideDateCount + 'px';

  function moveSlide(num) {
    slides.style.left = -num * 700 + 'px';
    currentIdx = num;
  }

  prev.addEventListener('click', function () {
    /*첫 번째 슬라이드로 표시 됐을때는 
    이전 버튼 눌러도 아무런 반응 없게 하기 위해 
    currentIdx !==0일때만 moveSlide 함수 불러옴 */
    if (currentIdx !== 0) moveSlide(currentIdx - 1);
  });
  
  next.addEventListener('click', function () {
    /* 마지막 슬라이드로 표시 됐을때는 
    다음 버튼 눌러도 아무런 반응 없게 하기 위해
    currentIdx !==slideCount - 1 일때만 
    moveSlide 함수 불러옴 */
    if (currentIdx !== 4) {
      moveSlide(currentIdx + 1);
    }
  })
  const sendRequest = async() => {
    const url = '/match/ended/'
    let userMatches = await axios.get(url)
    userMatches = userMatches.data.userMatches
    console.log('userMatches:', userMatches)
    //userMatches: [{}, {}]
    createModal(userMatches)
  }
  document.querySelector('header h1').addEventListener('click', sendRequest)

  sendRequest()
  window.setInterval(sendRequest, 10000)  //30분마다 Ajax 요청
  
  const createModal = (userMatches) => {
    const alarmModalList = document.querySelector('.alarm_modal_list')
    alarmModalList.innerHTML = ''
    for (let i = 0; i<userMatches.length; i++ ) {
      match = userMatches[i]
      alarmModalList.innerHTML += `
      <div class="alarm_modal" id="${i}">
        <div>${match.host_teamname} VS ${match.participant_teamname}</div>
        <div>경기 종료 시간: ${match.end_time}</div>
        <div>즐거운 경기 되셨나요? 수고한 상대팀에게 좋은 점수 부탁드려요!</div>
        <form action="/rate/${match.match_id}" method="post">
          {% csrf_token %}
          <label>실력: <input name="level" type="number" max="10"></label>
          <label>매너: <input name="manner" type="number" max="10"></label>
          <div class="rate_save">
            <input type="submit" value="완료">
          </div>
        </form>
      </div>
      `
    }
  }
</script>
</html>